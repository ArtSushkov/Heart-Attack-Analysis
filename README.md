# Сервис предсказания риска сердечных приступов
[![License](https://img.shields.io/badge/License-MIT-green)](LICENSE) 

## Обзор проекта
Сервис предоставляет API для прогнозирования риска сердечных приступов у пациентов на основе медицинских данных. Решение включает:
- Модель машинного обучения (CatBoost)
- REST API на FastAPI для обработки запросов
- Автоматизированную предобработку данных
- Документированные методы работы
- Комплексную систему тестирования

## Требования
- Python 3.9+
- Установленные зависимости из `requirements.txt`

## Установка
1. Клонируйте репозиторий:
```bash
git clone <ссылка на репозиторий>
cd <директория проекта>
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Убедитесь, что в директории `artifacts` находятся:
- `catboost_model.cbm` - обученная модель
- `preprocessor.pkl` - артефакты предобработки

## Запуск сервиса
```bash
uvicorn main:app --reload --port 8000
```
Сервис будет доступен по адресу: `http://localhost:8000/docs`

## Использование API

### 1. Проверка работоспособности
**Endpoint:**  
`GET /health`

**Пример запроса:**
```bash
curl http://localhost:8000/health
```

**Пример ответа:**
```json
{
  "status": "OK",
  "model_loaded": true,
  "service": "Heart Attack Risk Prediction API",
  "version": "1.0.0"
}
```

### 2. Получение предсказаний
**Endpoint:**  
`POST /predict`

**Параметры:**
- `file`: CSV-файл с данными пациентов (обязательное поле)

**Требования к CSV:**
- Должен содержать колонку `id`
- Должен включать признаки, использованные при обучении модели

**Пример запроса через curl:**
```bash
curl -X POST -F "file=@test_data.csv" http://localhost:8000/predict
```

**Пример успешного ответа:**
```json
{
  "status": "success",
  "predictions_count": 100,
  "high_risk_count": 15,
  "predictions": [
    {
      "patient_id": 12345,
      "prediction": 1,
      "risk_level": "высокий",
      "explanation": "Рекомендуется консультация кардиолога"
    },
    {
      "patient_id": 12346,
      "prediction": 0,
      "risk_level": "низкий",
      "explanation": "Риск в пределах нормы"
    }
  ]
}
```

## Описание ключевых компонентов

### 1. DataPreprocessor (`app/preprocessing.py`)
Класс для предобработки входных данных.

**Основные методы:**
- `__init__(artifacts_path)`: Загружает артефакты предобработки
- `transform(df)`: Выполняет преобразование данных:
  1. Проверка обязательных признаков
  2. Удаление строк с пропущенными значениями
  3. Преобразование типов данных
  4. Кодирование категориальных признаков
  5. Масштабирование числовых признаков

### 2. ModelWrapper (`app/model.py`)
Класс для работы с моделью предсказания.

**Основные методы:**
- `__init__(model_path, preprocessor_path)`: Загружает модель и артефакты
- `predict_proba(data)`: Возвращает вероятности класса 1 (высокий риск)
- `predict(data, threshold)`: Возвращает бинарные предсказания
- `predict_to_csv()`: Сохраняет предсказания в CSV (для пакетной обработки)

### 3. FastAPI приложение (`main.py`)
Реализует REST API для взаимодействия с сервисом.

**Эндпоинты:**
- `/health`: Проверка работоспособности сервиса
- `/predict`: Основной endpoint для получения предсказаний

## Тестирование
Проект включает комплексную систему автоматических тестов, которые гарантируют корректность работы всех компонентов системы.

### Структура тестов
```
tests/
├── test_preprocessing.py  # Тесты предобработки данных
└── test_api.py            # Тесты API endpoints
```

### Детальное описание тестов

#### 1. Тесты предобработки данных (`tests/test_preprocessing.py`)  
Проверяют корректность работы класса `DataPreprocessor`:
- **Инициализация препроцессора**: Проверка загрузки артефактов, наличия категориальных/числовых признаков, компонентов обработки (кодировщик, импьютеры)
- **Проверка обязательных признаков**: Тестирование реакции на отсутствие необходимых фичей (выбрасывание исключения)
- **Обработка категориальных признаков**: Проверка кодирования, обработки пропусков и преобразования типов данных
- **Обработка числовых признаков**: Тестирование масштабирования (при включённом скейлере) или сохранения оригинальных значений
- **Обработка пропущенных значений**: Проверка импьютинга, удаления строк и корректности маски валидных записей
- **Параметризованное тестирование кодирования**: Проверка обработки разных форматов значений для признака `Gender` (регистр, сокращения)
- **Преобразование типов данных**: Контроль корректности типов после обработки
- **Дымовой тест**: Базовая проверка работоспособности на минимальных данных
- **Тест производительности**: Обработка 1000 записей с проверкой корректности обработки и отсутствия ошибок
  
#### 2. Тесты API (`tests/test_api.py`)
Проверяют работу API endpoints:
- **Проверка работоспособности**: Тест эндпоинта `/health`
- **Тестирование предсказаний**: Проверка корректности работы `/predict` endpoint:
  - Обработка CSV-файлов
  - Проверка структуры ответа
  - Контроль наличия обязательных полей
  - Проверка типов данных в ответе

### Примеры запуска тестов
Запуск всех тестов:
```bash
pytest
```

Запуск только тестов API:
```bash
pytest tests/test_api.py
```

Запуск конкретного теста:
```bash
pytest tests/test_preprocessing.py::test_gender_encoding
```

## Пример входных данных (CSV)
```csv
,Age,Cholesterol,Heart rate,Diabetes,Family History,Smoking,Obesity,Alcohol Consumption,Exercise Hours Per Week,Diet,Previous Heart Problems,Medication Use,Stress Level,Sedentary Hours Per Day,Income,BMI,Triglycerides,Physical Activity Days Per Week,Sleep Hours Per Day,Blood sugar,CK-MB,Troponin,Gender,Systolic blood pressure,Diastolic blood pressure,id
0,0.4943820224719101,0.2642857142857143,0.0623281393217231,0.0,1.0,1.0,1.0,1.0,0.3616179475374933,2,0.0,0.0,8.0,0.1943701325296906,0.5877588498420819,0.2834904588967591,0.3064935064935065,1.0,0.3333333333333333,0.2270175751137986,0.0482287853675997,0.0365123661820742,Male,0.2838709677419355,0.3720930232558139,7746
1,0.2247191011235955,0.9535714285714284,0.0824931255728689,1.0,0.0,0.0,1.0,0.0,0.9964834861899992,2,1.0,1.0,5.0,0.3298883019986054,0.6028825404084432,0.4670359622438044,0.087012987012987,0.0,0.1666666666666666,0.2270175751137986,0.0482287853675997,0.0365123661820742,Female,0.7032258064516128,0.4418604651162791,4202
```

## Обработка ошибок
Сервис возвращает понятные сообщения об ошибках:
- При отсутствии файла: `400 Неверный запрос`
- При неправильном формате файла: `400 Неверный формат файла`
- При отсутствии колонки `id`: `400 Отсутствует обязательная колонка`
- При внутренних ошибках: `500 с описанием ошибки`
